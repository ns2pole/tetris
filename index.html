<!DOCTYPE html>
<html lang="jp">
    <head>
        <script src="./Block.js"></script>
        <script src="./Wall.js"></script>
        <script src="./FourPieces.js"></script>
        <script src="./Shape_S.js"></script>
        <script src="./Shape_T.js"></script>
        <script src="./Field.js"></script>
        <script src="./Constants.js"></script>
    </head>
    <body onLoad="init()">
        <button style="width:120px; height:120px;"id="startButton">START</button>
        <button style="width:120px; height:120px;"id="pauseButton">PAUSE</button>
        <canvas id="canvas" style="background-color:yellow;" height="1000" width="1000">
        </canvas>
        <audio id="music" src="./47.mp3"></audio>
        <img id="blockImg" src="block.png" style="display:none" />
        <img id="wallImg" src="wall.png" style="display:none" />
        <script>
            const initialPosition = {x: 2, y: 1}
            let field = new Field();
            const gc = document.getElementById("canvas").getContext("2d");
            let controlledFourPieces = FourPieces.getShapeRamdomly(initialPosition.x, initialPosition.y);
            function timeElapse() {
                gc.clearRect(0, 0, ONE_CELL_SIZE * field.getWidth() , ONE_CELL_SIZE * field.getDepth());
                let virtualFourPiece = new Shape_S(controlledFourPieces.x, controlledFourPieces.y + 1)
                if(virtualFourPiece.canBePlacedIn(field)) {
                    //newしないと、controlledFourPieces.yを+1してもblocksのy座標が変わらない
                    controlledFourPieces = new Shape_S(controlledFourPieces.x, controlledFourPieces.y + 1);
                } else {
                    field.place(controlledFourPieces);
                    controlledFourPieces = new Shape_S(initialPosition.x, initialPosition.y);
                }
                field.draw(gc);
                controlledFourPieces.draw(gc)
            }

            function init() {
                let startButton = document.getElementById("startButton")
                let pauseButton = document.getElementById("pauseButton")
                let music = document.getElementById("music")
                field.draw(gc)
                controlledFourPieces.draw(gc)
                startButton.addEventListener("click", function() {
                    music.play()
                    setInterval(timeElapse, 1000)
                })
                pauseButton.addEventListener("click", function() {
                    music.pause()
                })
            }

            //randomに出現させるためにshapecodeがいりそう
            //回転含めるとshape多すぎるから多過ぎるから回転が要りそう
            //壁に対して動かした時のバグ修正
            //shapeごとに色分け
            //形が勝手にshape_sに変わってしまうバグ
            //回転のkeypressイベント
            //一行埋めたら消す→ブロックは消えた分落下する


            document.addEventListener('keypress', function(e) {
                gc.clearRect(0, 0, ONE_CELL_SIZE * field.getWidth() , ONE_CELL_SIZE * field.getDepth());
                if(e.key === "l") controlledFourPieces = new Shape_S(controlledFourPieces.x + 1, controlledFourPieces.y);
                if(e.key === "r") controlledFourPieces = new Shape_S(controlledFourPieces.x - 1, controlledFourPieces.y);
                if(e.key === "u") controlledFourPieces = new Shape_S(controlledFourPieces.x, controlledFourPieces.y - 1);
                if(e.key === "d") controlledFourPieces = new Shape_S(controlledFourPieces.x, controlledFourPieces.y + 1);
                controlledFourPieces.draw(gc)
            })
        </script>
    </body>
</html>